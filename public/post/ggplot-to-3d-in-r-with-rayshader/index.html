<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">
  <meta name="robots" content="index,follow">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Carlos Vecina">

  
  
  
    
  
  <meta name="description" content="Do you want to add a 3rd dimension to your R plot? In this post we show you how to turn your R ggplot to a 3D plot easily with Rayshader.">

  
  <link rel="alternate" hreflang="es" href="/es/post/de-ggplot-a-3d-en-r-con-rayshader/">
  
  <link rel="alternate" hreflang="en-us" href="/post/ggplot-to-3d-in-r-with-rayshader/">

  


  
  
  
  <meta name="theme-color" content="#0294A5">
  

  
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      
        
      

      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  





<script async src="https://www.googletagmanager.com/gtag/js?id=G-BHP7JGTF0S"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'G-BHP7JGTF0S', {});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu7deb2a6bfe7da9ae71f9387d98d158da_12352_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu7deb2a6bfe7da9ae71f9387d98d158da_12352_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="/post/ggplot-to-3d-in-r-with-rayshader/">

  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="TypeThePipe">
  <meta property="og:url" content="/post/ggplot-to-3d-in-r-with-rayshader/">
  <meta property="og:title" content="Turn your GGplot to 3D animation. Awesome 2D to 3D plots in R with Rayshader | TypeThePipe">
  <meta property="og:description" content="Do you want to add a 3rd dimension to your R plot? In this post we show you how to turn your R ggplot to a 3D plot easily with Rayshader."><meta property="og:image" content="/post/ggplot-to-3d-in-r-with-rayshader/featured.gif">
  <meta property="twitter:image" content="/post/ggplot-to-3d-in-r-with-rayshader/featured.gif"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2019-07-27T00:00:00&#43;00:00">
    
    <meta property="article:modified_time" content="2019-07-27T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/ggplot-to-3d-in-r-with-rayshader/"
  },
  "headline": "Turn your GGplot to 3D animation. Awesome 2D to 3D plots in R with Rayshader",
  
  "image": [
    "/post/ggplot-to-3d-in-r-with-rayshader/featured.gif"
  ],
  
  "datePublished": "2019-07-27T00:00:00Z",
  "dateModified": "2019-07-27T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Carlos Vecina"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "TypeThePipe",
    "logo": {
      "@type": "ImageObject",
      "url": "/images/logo_hu404f0ea59597fa66f625b1ea06c896ea_259550_192x192_fit_lanczos_2.png"
    }
  },
  "description": "Do you want to add a 3rd dimension to your R plot? In this post we show you how to turn your R ggplot to a 3D plot easily with Rayshader."
}
</script>

  

  


  


  







  <title>Turn your GGplot to 3D animation. Awesome 2D to 3D plots in R with Rayshader | TypeThePipe</title>
  <script async defer src="https://tools.luckyorange.com/core/lo.js?site-id=10579286"></script>
  
  
<script>var ezoicId = 473828; </script>
<script type="text/javascript" src="//go.ezoic.net/ezoic/ezoic.js"></script>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  






  


<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/"><img src="/images/logo_hu404f0ea59597fa66f625b1ea06c896ea_259550_0x70_resize_lanczos_2.png" alt="TypeThePipe"></a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/"><img src="/images/logo_hu404f0ea59597fa66f625b1ea06c896ea_259550_0x70_resize_lanczos_2.png" alt="TypeThePipe"></a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#vizstips"><span>Vizs & Tips</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#people"><span>About Us</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#mentorship"><span>Mentorship Program</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      

      
      <li class="nav-item dropdown i18n-dropdown">
        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-globe mr-1" aria-hidden="true"></i><span class="d-none d-lg-inline">English</span>
        </a>
        <div class="dropdown-menu">
          <div class="dropdown-item dropdown-item-active">
            <span>English</span>
          </div>
          
          <a class="dropdown-item" href="/es/post/de-ggplot-a-3d-en-r-con-rayshader/">
            <span>Español</span>
          </a>
          
        </div>
      </li>
      

    </ul>

  </div>
</nav>


  


        <article class="article">
            





















  
  


<div class="article-container pt-3">
  <h1>Turn your GGplot to 3D animation. Awesome 2D to 3D plots in R with Rayshader</h1>

  
  <p class="page-subtitle">Do you want to add a 3rd dimension to your R plot? In this post we show you how to turn your R ggplot to a 3D plot easily with Rayshader.</p>
  

  


<div class="article-metadata">

  
  
  
  
  <div>
    

  
  <span><a href="/authors/carlos-vecina/">Carlos Vecina</a></span>
  </div>
  
  

  

  

  

  
  
  

  
  
  
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/categories/r/">R</a>, <a href="/categories/post/">Post</a></span>
  

</div>

  














</div>





            <div class="article-container">
              <div class="article-style">
                
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>


<p><img src="/en/post/ggplot-to-3d-in-r-with-rayshader/featured.gif" height="250px" width="400px" alt="3D Spanish map rotating. Showing average age of eac municipy in a third dimension." /></p>
<hr />
<p><em>In 7 minutes reading, You will learn how to turn your ggplot visualizations into amazing interactive 3D plots you can export or embed in HTML/Rmarkdown. Or even better, you will export as mp4 an animation rotating the figure.</em></p>
<p><em>As a use case, we are going to join the Spanish demographic data and GIS map, and then visualize it</em></p>
<hr />
<p><img src="/en/post/ggplot-to-3d-in-r-with-rayshader/rayshader_header.png" height="350px" width="500px" /></p>
<p><br></p>
<div id="introduction" class="section level2">
<h2><strong>1. Introduction</strong></h2>
<p><br></p>
<p>During the last weeks a ‘new’ package has received the R community attention. We say ‘new’ because it joined recently the CRAN, althought the very first commits in github repo date back more than a year. Its name is <strong>rayshader</strong> and in the author’s own words:</p>
<p><br></p>
<blockquote>
<p>“rayshader uses elevation data in a base R matrix and a combination of raytracing, spherical texture mapping, overlays, and ambient occlusion to generate beautiful topographic 2D and 3D maps”</p>
</blockquote>
<p><br></p>
<p>In my view, Tyler Morgan-Wall (package’s author) hit the jackpot with the new addition of two specific functions. These are plot_gg() and render_movie(). The first one converts the ggplot to a 3D figure using one or two lines of code making it deadly-simple. The second one renders an animation in which we can set up several parameters like zoom, fps, angles and inclinations… as user-friendly as possible.</p>
<p><br></p>
<p><img src="/en/post/ggplot-to-3d-in-r-with-rayshader/rayshader_repo.png" height="770px" width="770px" /></p>
<p><br></p>
<div id="lets-try-these-new-functionalities" class="section level4">
<h4><strong>Let’s try these new functionalities! </strong></h4>
<p>The only condition you must have a color or fill <em>aesthetic</em>, unless you can also play in the same plot wiht size.
Many times 3D plots are not the right choice for most of the data visualization cases. Therefore, I tried to bring to this article a non gratuitous example.</p>
<p>As a practical challenge, we will visualize in an interactive 3D map the average age in each city of Spain. Cool? First of all we need the population stats. We get it from the INE webpage. Secondly we have to delimiter Spanish cities with they GIS coordinates. Then we are merging these data to create a ggplot chart. Once we have the ggplot object we are going to use the rayshader package to map color aesthetic to the third spatial dimension. To conclude, we are going to render it as rotating 3D video.</p>
<p>Let´s do it step by step.</p>
<p><br></p>
</div>
</div>
<div id="visualazing-spanish-cities-average-age." class="section level2">
<h2><strong>2. Visualazing Spanish cities average age.</strong></h2>
<p>We usually want to start our pratical work drawing the main steps in our project and our principal goals. So in a general layer, we want to visualiza the average age. Firstly in a ggplot-color way, go one step further and make the plot 3D and end with an animation where the Z axis will be the average age.</p>
<p><br></p>
<div id="downloading-census-data" class="section level3">
<h3>2.1- Downloading census data</h3>
<p>As said, for our purpose, we need to collect data from two sources. We use INE open data portal to download census ages data by city. After a not very user-friendly search, we got it. I provide you the following link, where you can find the continuous register statistics:
<a href="http://www.ine.es/dyngs/INEbase/es/operacion.htm?c=Estadistica_C&amp;cid=1254736177012&amp;menu=resultados&amp;secc=1254736195461&amp;idp=1254734710990">link</a>.</p>
<p>Aiming to keep focused, we don’t get distracted and we are going to download the 2018 file. However, is worth noting the <a href="https://github.com/oddworldng/INEbaseR/"><em>INEbase</em></a> efforts to make easier the INE open data platform.</p>
<p>We start loading (or downloading) the packages we are going to use. In other article or tip we will provide a custom function to Load and Download Rpackages in onle line.
Moreover we define the required functions and download directories.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(pxR)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(RColorBrewer)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">library</span>(rgeos)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="co">#install.packages(&quot;rgdal&quot;, repos = &quot;http://cran.us.r-project.org&quot;) reinstall cause gpclib dependencie https://stackoverflow.com/questions/30790036/error-istruegpclibpermitstatus-is-not-true</span></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">library</span>(rgdal)</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">library</span>(rayshader)</a>
<a class="sourceLine" id="cb1-7" title="7"><span class="kw">library</span>(knitr)</a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">library</span>(magrittr)</a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb1-10" title="10"></a>
<a class="sourceLine" id="cb1-11" title="11">as.numeric.factor &lt;-<span class="st"> </span><span class="cf">function</span>(x) {    <span class="co"># Custom function to convert fctr to num factor value</span></a>
<a class="sourceLine" id="cb1-12" title="12">    <span class="kw">return</span>(<span class="kw">suppressWarnings</span>(<span class="kw">as.numeric</span>(<span class="kw">levels</span>(x))[x]))</a>
<a class="sourceLine" id="cb1-13" title="13">}</a>
<a class="sourceLine" id="cb1-14" title="14"> </a>
<a class="sourceLine" id="cb1-15" title="15"><span class="cf">if</span>(<span class="op">!</span><span class="kw">dir.exists</span>(<span class="st">&quot;data&quot;</span>)) <span class="kw">dir.create</span>(<span class="st">&quot;data&quot;</span>)  <span class="co"># Create the download directory</span></a></code></pre></div>
<p><br></p>
<p>Downloading INE 2018 file:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">utils<span class="op">::</span><span class="kw">download.file</span>(<span class="dt">url =</span> <span class="st">&quot;http://www.ine.es/pcaxisdl/t20/e245/p05/a2018/l0/00000006.px&quot;</span>,</a>
<a class="sourceLine" id="cb2-2" title="2">                     <span class="dt">destfile =</span> <span class="st">&quot;data/census_2018.px&quot;</span>)</a></code></pre></div>
<p><br></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">tbl_census_<span class="dv">2018</span> &lt;-<span class="st"> </span><span class="kw">read.px</span>(<span class="st">&quot;data/census_2018.px&quot;</span>) <span class="op">%&gt;%</span><span class="st">              </span><span class="co"># Load &amp; format</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="st">  </span><span class="kw">as_tibble</span>()</a></code></pre></div>
<p>We parse the data to obtain a name,pcode,average age dataframe</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">tbl_census_<span class="dv">2018</span> <span class="op">%&lt;&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="st">  </span><span class="kw">set_names</span>(<span class="kw">c</span>(<span class="st">&quot;age&quot;</span>, <span class="st">&quot;city&quot;</span>, <span class="st">&quot;sex&quot;</span>, <span class="st">&quot;population&quot;</span>)) <span class="op">%&gt;%</span><span class="st">             </span><span class="co"># Cambiamos los nombre</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="st">  </span><span class="kw">na.omit</span>() <span class="op">%&gt;%</span><span class="st">                                                    </span><span class="co"># Na rmv</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="st">  </span><span class="kw">filter</span>((city<span class="op">!=</span><span class="st">&quot;Total&quot;</span>)<span class="op">&amp;</span>(age<span class="op">!=</span><span class="st">&quot;Total&quot;</span>)<span class="op">&amp;</span>(sex<span class="op">==</span><span class="st">&quot;Ambos sexos&quot;</span>)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Duplicate info rmv</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="st">  </span><span class="kw">separate</span>(city, <span class="kw">c</span>(<span class="st">&#39;postal_code&#39;</span>, <span class="st">&#39;city_name&#39;</span>), <span class="dt">sep=</span><span class="st">&quot;-&quot;</span>) <span class="op">%&gt;%</span><span class="st">       </span><span class="co"># Sep City column</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> <span class="kw">as.numeric.factor</span>(age)) <span class="op">%&gt;%</span><span class="st">                         </span><span class="co"># Conv to numeric</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="st">  </span><span class="kw">group_by</span>(city_name, postal_code) <span class="op">%&gt;%</span><span class="st">                             </span><span class="co"># Group to operate</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">avg_age =</span> <span class="kw">sum</span>(population<span class="op">*</span>age,<span class="dt">na.rm =</span> T)<span class="op">/</span><span class="kw">sum</span>(population,<span class="dt">na.rm=</span>T)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Avg age</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="st">  </span><span class="kw">select</span>(city_name, postal_code, avg_age)                          <span class="co"># Discard columns</span></a></code></pre></div>
<p><br></p>
</div>
<div id="downloading-gis-data" class="section level3">
<h3>2.2- Downloading GIS data</h3>
<p>The second source we are going to use is the Geo data. We will use cities coordinates and matching it with Spanish demographic data previously obtained.</p>
<p>Downloading map overlay:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">temp &lt;-<span class="st"> </span><span class="kw">tempfile</span>()                              <span class="co"># Create the tempfile</span></a>
<a class="sourceLine" id="cb5-2" title="2">u=<span class="st">&quot;http://www.arcgis.com/sharing/rest/content/items/8e31c4c1a0b348f79058f212d0d807a1/data&quot;</span></a>
<a class="sourceLine" id="cb5-3" title="3">utils<span class="op">::</span><span class="kw">download.file</span>(<span class="dt">url =</span> u, <span class="dt">destfile =</span> temp,</a>
<a class="sourceLine" id="cb5-4" title="4">                     <span class="dt">mode=</span><span class="st">&quot;wb&quot;</span>)                 <span class="co"># Binary mode for correct download</span></a>
<a class="sourceLine" id="cb5-5" title="5"></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="kw">unzip</span>(temp, <span class="dt">exdir =</span> <span class="st">&quot;data/cities_gis&quot;</span>)          <span class="co"># Unzip in data/cities_gis</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="kw">unlink</span>(temp)                                    <span class="co"># Delete temp file</span></a></code></pre></div>
<p>We parse the spatial information to convert it into tabular data. We expect that the Canary Islands coordinates will skew the plot, so it’s our decision to keep focused in our 3D objetive and filter peninsular coordinates. It’s also possible, and a better practice, to move insular coordinates looking for a compact plot, instead of filter them out.</p>
<p>To complete this data processing, we use fortify function that allows us to don’t load more packages. However, this function throws a warning suggesting the broom::tidy() one.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">tlb_cities_gis &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="dt">dsn =</span> <span class="st">&quot;./data/cities_gis/Municipios_ETRS89_30N.shp&quot;</span>,</a>
<a class="sourceLine" id="cb6-2" title="2">                              <span class="dt">verbose=</span><span class="ot">FALSE</span>) <span class="co"># Spatial data reading</span></a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">tlb_cities_gis <span class="op">%&lt;&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="st">  </span><span class="kw">fortify</span>(<span class="dt">region =</span> <span class="st">&quot;Codigo&quot;</span>) <span class="co"># %&gt;%             # Conv &quot;spatial object&quot; to data.frame</span></a>
<a class="sourceLine" id="cb7-3" title="3">  <span class="co"># broom::tidy()</span></a>
<a class="sourceLine" id="cb7-4" title="4"></a>
<a class="sourceLine" id="cb7-5" title="5">plot_canarias &lt;-<span class="st"> </span>F                              <span class="co"># Control param, initial app config</span></a>
<a class="sourceLine" id="cb7-6" title="6"></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="cf">if</span>(plot_canarias<span class="op">==</span>F){                           <span class="co"># Should be moduled in a funct</span></a>
<a class="sourceLine" id="cb7-8" title="8">  tlb_cities_gis <span class="op">%&lt;&gt;%</span></a>
<a class="sourceLine" id="cb7-9" title="9"><span class="st">  </span><span class="kw">filter</span>((long<span class="op">&gt;</span><span class="dv">0</span>) <span class="op">&amp;</span><span class="st"> </span>(lat<span class="op">&gt;</span><span class="dv">4000000</span>))              <span class="co"># Filter peninsular data</span></a>
<a class="sourceLine" id="cb7-10" title="10">} </a></code></pre></div>
<p>Finaly, we join both creating the final dataset, which we are going to use to make the plots. Note that we use left join to keep de geo data.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">tbl_cities_avg_age &lt;-<span class="st"> </span>tlb_cities_gis <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="st">  </span><span class="kw">left_join</span>(tbl_census_<span class="dv">2018</span>, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;id&quot;</span> =<span class="st"> &quot;postal_code&quot;</span>)) </a></code></pre></div>
<p>As a good practice, we are going to check the number of NAs generated after the left join. These NAs meaning is that there are cities localized but without average year information</p>
<p>We can see that these missing values represents just 1% of the data, so we are going to impute them with the previous postal code info. I bet that you can easily improve this procedure but I consider it’s prety acceptable enought seeing the low NA ratio.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">  tbl_cities_avg_age <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="st">    </span><span class="kw">group_by</span>(id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">na =</span> <span class="kw">sum</span>(<span class="kw">is.na</span>(avg_age))) <span class="op">%&gt;%</span><span class="st">                 </span><span class="co"># NAs by city</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">missing_perc =</span> <span class="kw">sum</span>(na<span class="op">&gt;</span><span class="dv">0</span>)<span class="op">/</span><span class="kw">length</span>(na)<span class="op">*</span><span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Perc cities with at least 1 na </span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="st">    </span><span class="kw">select</span>(missing_perc)</a>
<a class="sourceLine" id="cb9-6" title="6"></a>
<a class="sourceLine" id="cb9-7" title="7"></a>
<a class="sourceLine" id="cb9-8" title="8">tbl_cities_avg_age <span class="op">%&lt;&gt;%</span><span class="st">       </span></a>
<a class="sourceLine" id="cb9-9" title="9"><span class="st">  </span><span class="kw">arrange</span>(id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-10" title="10"><span class="st">  </span><span class="kw">fill</span>(avg_age, <span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>)            <span class="co"># Fill with the previous pc data.</span></a></code></pre></div>
<p><br></p>
</div>
<div id="ggplot-visualization" class="section level3">
<h3>2.3- GGplot visualization</h3>
<p>Inspired in <a href="http://blog.manugarri.com/making-a-beautiful-map-of-spain-in-ggplot2/" class="uri">http://blog.manugarri.com/making-a-beautiful-map-of-spain-in-ggplot2/</a></p>
<p>Once we have created the final dataset, we are able to start ploting it. Of course longitude in X-axis and latitude en Y-axis. Firstly average city age is represented using a color palette. Red colours are assigned to older people and blue ones to younger city population. We get it in ggplot with the fill aesthetic.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">myPalette &lt;-<span class="st"> </span><span class="kw">colorRampPalette</span>(<span class="kw">rev</span>(<span class="kw">brewer.pal</span>(<span class="dv">11</span>, <span class="st">&quot;Spectral&quot;</span>)))      <span class="co"># Create reverse Spectral palette</span></a>
<a class="sourceLine" id="cb10-2" title="2"></a>
<a class="sourceLine" id="cb10-3" title="3">plot_cities &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="st">  </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> tbl_cities_avg_age, <span class="kw">aes</span>(<span class="dt">fill =</span> avg_age,   </a>
<a class="sourceLine" id="cb10-5" title="5">                                         <span class="dt">x =</span> long, </a>
<a class="sourceLine" id="cb10-6" title="6">                                         <span class="dt">y =</span> lat, </a>
<a class="sourceLine" id="cb10-7" title="7">                                         <span class="dt">group =</span> id)) <span class="op">+</span><span class="st">      </span><span class="co"># Dummy variable to correct fill by PCode.</span></a>
<a class="sourceLine" id="cb10-8" title="8"><span class="st">  </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colours=</span><span class="kw">myPalette</span>(<span class="dv">4</span>)) <span class="op">+</span><span class="st">                 </span><span class="co"># Choose palette colours.</span></a>
<a class="sourceLine" id="cb10-9" title="9"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">fill=</span><span class="st">&quot;Avg age&quot;</span>)</a>
<a class="sourceLine" id="cb10-10" title="10"><span class="kw">plot</span>(plot_cities)</a></code></pre></div>
<p><img src="/en/post/ggplot-to-3d-in-r-with-rayshader/ggplot_spain_map_average_age.png" height="770px" width="770px" /></p>
<p><br></p>
</div>
<div id="d-rayshader-visualization" class="section level3">
<h3>2.4- 3D Rayshader Visualization!</h3>
<p>That was pretty nice. It’s sure that you can reach the general propose to be able to locate inmediately older an younger zones. Although as we will disccuss in a future post, human eyes aren’t ready to distinguiss almost nothing but big color contrasts. What about complement color with a third dimension through z axis?</p>
<p>Let’s see how it works</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">plot_gg</span>(plot_cities,<span class="dt">multicore=</span><span class="ot">TRUE</span>,<span class="dt">width=</span><span class="dv">5</span>,<span class="dt">height=</span><span class="dv">3</span>,<span class="dt">scale=</span><span class="dv">310</span>)    <span class="co"># Plot_gg de rayshader</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="kw">render_snapshot</span>(<span class="dt">filename =</span> <span class="st">&quot;3D_spain&quot;</span>)</a></code></pre></div>
<p><img src="/en/post/ggplot-to-3d-in-r-with-rayshader/rayshader_3D_spain_map.png" height="600px" width="600px" /></p>
<p><br></p>
<p>Hmm you told something about render_movie()… What if we anime it?</p>
<p><br></p>
</div>
<div id="d-animation-with-rayshader" class="section level3">
<h3>2.5- 3D animation with rayshader</h3>
<p>In the last plot, it results the correct angle election as a key point. But what if we animate it with a rotating effect?</p>
<p>This is what the following function take cares on:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">render_movie</span>(<span class="st">&quot;img/movie_spain.mp4&quot;</span>,<span class="dt">frames =</span> <span class="dv">720</span>, <span class="dt">fps=</span><span class="dv">30</span>,<span class="dt">zoom=</span><span class="fl">0.6</span>,<span class="dt">fov =</span> <span class="dv">30</span>)</a></code></pre></div>
<p><strong>This way you can achieve the header 3D rotating image!</strong></p>
<p><br></p>
<p>You can see related posts on <a href="https://typethepipe.com">TypeThePipe</a></p>
<p><br></p>
<style>
p {
  word-spacing: 3px;
  text-indent: 20px;
  text-align: justify;
}
.page-subtitle {
  text-align: left  !important;
    text-indent: 0px !important;
}
.card-text {
  text-align: left  !important;
    text-indent: 0px !important;
}
</style>
<script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/unique-methods/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script>
<script type="text/javascript">window.dojoRequire(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us4.list-manage.com","uuid":"91551f7ed29389a0de4f47665","lid":"d95c503a48","uniqueMethods":true}) })</script>
</div>
</div>

              </div>
              







<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=/post/ggplot-to-3d-in-r-with-rayshader/&amp;text=Turn%20your%20GGplot%20to%203D%20animation.%20Awesome%202D%20to%203D%20plots%20in%20R%20with%20Rayshader" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=/post/ggplot-to-3d-in-r-with-rayshader/&amp;t=Turn%20your%20GGplot%20to%203D%20animation.%20Awesome%202D%20to%203D%20plots%20in%20R%20with%20Rayshader" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Turn%20your%20GGplot%20to%203D%20animation.%20Awesome%202D%20to%203D%20plots%20in%20R%20with%20Rayshader&amp;body=/post/ggplot-to-3d-in-r-with-rayshader/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=/post/ggplot-to-3d-in-r-with-rayshader/&amp;title=Turn%20your%20GGplot%20to%203D%20animation.%20Awesome%202D%20to%203D%20plots%20in%20R%20with%20Rayshader" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Turn%20your%20GGplot%20to%203D%20animation.%20Awesome%202D%20to%203D%20plots%20in%20R%20with%20Rayshader%20/post/ggplot-to-3d-in-r-with-rayshader/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=/post/ggplot-to-3d-in-r-with-rayshader/&amp;title=Turn%20your%20GGplot%20to%203D%20animation.%20Awesome%202D%20to%203D%20plots%20in%20R%20with%20Rayshader" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>












  
    
    





  
  
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <img class="avatar mr-3 avatar-circle" src="/authors/carlos-vecina/carlos-vecina-avatar_hudcecee8c8ed4dd07fd2b73e656fad71c_149347_270x270_fill_lanczos_center_2.png" alt="Carlos Vecina">
    

    <div class="media-body">
      <h5 class="card-title"><a href="/authors/carlos-vecina/">Carlos Vecina</a></h5>
      <h6 class="card-subtitle">Senior Data Scientist at Jobandtalent</h6>
      <p class="card-text">Senior Data Scientist at Jobandtalent  |  AI &amp; Data Science for Business</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/deepchals" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/carlos-vecina/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/CarlosVecina" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://autarponics.com" target="_blank" rel="noopener">
        <i class="fa fa-home"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>


  










  
  


            </div>
        </article>
  

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/python.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.37431be2d92d7fb0160054761ab79602.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>

    
    

    






  
  
  <div class="container">
    <footer class="site-footer">
  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
       &middot; 
      <a href="/terms/">Terms and Conditions</a>
    
  </p>
  

  <p class="powered-by">
    

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.
	<a href="https://www.r-bloggers.com/">
	<img border="0" alt="R Bloggers icon" src="/img/r_bloggers.png" width="100" height="100">
	</a>
	<br>
	<a href="https://www.python-bloggers.com/">
	<img border="0" alt="Python Bloggers icon" src="/img/python_logo.png" width="100" height="100">
	</a>
    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
  <style>
    #consent-notice {padding: 1rem 1rem; display: none; text-align: center; position: fixed; bottom: 0; width: calc(100% - 2rem); background: #222; color: rgba(255,255,255,0.8);}
    #consent-notice span {margin-right: 1rem;}
    #consent-notice button {cursor: pointer; display: inline-block; width: auto;}
    #consent-notice span a {color: inherit; text-decoration: underline; text-decoration-color: rgba(255,255,255,0.5);}
    #consent-notice button.btn {margin-left: 0.5rem;}
    #consent-notice button.btn.manage-consent {background: rgba(255,255,255,0.1); font-weight: normal;}
    
    #consent-overlay {position: fixed; left: 0; top: 0; width: 100%; height: 100vh; display: none; background: rgba(0,0,0,0.75); z-index: 999999; overflow: auto; cursor: pointer;}
    #consent-overlay.active {display: flex;}
    #consent-overlay > div {background: white; width: 100%; max-width: 30rem; padding: 1.75rem; margin: auto; cursor: initial;}
    #consent-overlay > div > div {display: flex; align-items: flex-start; margin-bottom: 1rem;}
    #consent-overlay > div > div:last-child {margin: 0;}
    #consent-overlay h3 {padding-top: 0;}
    #consent-overlay input {margin-top: 0.3rem;}
    #consent-overlay label {display: block;}
    #consent-overlay .btn {margin-right: 0.5rem;}
    #consent-overlay button.btn.save-consent {background: rgba(0,0,0,0.6); font-weight: normal;}

    @media (max-width: 767px) {
        #consent-overlay > div {padding: 1.75rem 1rem;}
        #consent-notice span {display: block; padding-top: 3px; margin-bottom: 1.5rem;}
        #consent-notice button.btn {position: relative; bottom: 4px;}
    }
</style>
<div id="consent-notice"><span>We would like to use <a class="manage-consent" href="#manage-consent">third party code</a> to improve the functionality of this website.</span><button class="btn manage-consent">Manage preferences</button><button class="btn deny-consent">Deny</button><button class="btn approve-consent">Allow</button></div>
<div id="consent-overlay">
    <div>
        
            <div>
                <input type="checkbox" id="item0" value="1" name="item0" checked disabled />
                <label for="item0">
                    <h3>Google Anaytics (functional)</h3>
                    <p>This code gives us insight into the number of anonymized people that visit our website, where they are from and what they are clicking on in order to create better content.</p>
                </label>
            </div>
        
            <div>
                <input type="checkbox" id="item1" value="1" name="item1"  />
                <label for="item1">
                    <h3>Marketing</h3>
                    <p>Marketing pourposes cookies.</p>
                </label>
            </div>
        
        <div>
            <button id="save-consent" class="btn save-consent" data-consentvalue="0">Save preferences</button>
            <button class="btn approve-consent">Allow all</button>
        </div>
    </div>
</div>
<script>

    const scripts = [];
    scripts[ 0 ] = "/js/mkt.js";

    function createCookie(name,value,days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + value + expires + "; path=/";
    }
    function readCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i=0;i < ca.length;i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }
    function eraseCookie(name) {
        createCookie(name,"",-1);
    }
    function denyAllConsentScripts() {
        var consentValue = "";
        scripts.forEach(function(){
            consentValue = consentValue + "0";
        });
        acceptSomeConsentScripts(consentValue);
    }
    function acceptAllConsentScripts() {
        var consentValue = "";
        scripts.forEach(function(){
            consentValue = consentValue + "1";
        });
        acceptSomeConsentScripts(consentValue);
    }
    function acceptSomeConsentScripts(consentValue) {
        setConsentInputs(consentValue);
        createCookie('consent-settings',consentValue,31);
        document.getElementById('consent-notice').style.display = 'none';
        document.getElementById('consent-overlay').classList.remove('active');
        loadConsentScripts(consentValue);
    }
    function loadConsentScripts(consentValue) {
        scripts.forEach(function(value,key){
            
            if(consentValue[key]=="1") {
                var s = document.createElement('script');
                s.type = 'text/javascript';
                s.src = value;
                document.body.appendChild(s);
            }
        });
    }
    function setConsentInputs(consentValue) {
        var elements = document.querySelectorAll('#consent-overlay input:not([disabled])');
        elements.forEach(function(el,index) {
            if(consentValue[index]=="1") el.checked = true;
            else el.checked = false;
        });
    }
    function setConsentValue() {
        var elements = document.querySelectorAll('#consent-overlay input:not([disabled])');
        var consentValue = "";
        elements.forEach(function(el) {
            if(el.checked) consentValue = consentValue + "1";
            else consentValue = consentValue + "0";
        });
        document.getElementById("save-consent").dataset.consentvalue = consentValue;
    }

    var elements = document.querySelectorAll('#consent-overlay input:not([disabled])');
    elements.forEach(function(el) {
        el.checked = false;
    });

    if(readCookie('consent-settings')) {
        var consentValue = readCookie('consent-settings').toString();
        
        setConsentInputs(consentValue);
        loadConsentScripts(consentValue);
    } else {
        document.getElementById('consent-notice').style.display = 'block';
    }
    var elements = document.querySelectorAll('.manage-consent');
    elements.forEach(function(el) {
        el.addEventListener("click",function() {
            document.getElementById('consent-overlay').classList.toggle('active');
        });
    });
    var elements = document.querySelectorAll('.deny-consent');
    elements.forEach(function(el) {
        el.addEventListener("click",function() {
            denyAllConsentScripts();
        });
    });
    var elements = document.querySelectorAll('.approve-consent');
    elements.forEach(function(el) {
        el.addEventListener("click",function() {
            acceptAllConsentScripts();
        });
    });
    document.getElementById("save-consent").addEventListener("click",function() {
        setConsentValue();
        acceptSomeConsentScripts(this.dataset.consentvalue);
    });
    document.getElementById("consent-overlay").addEventListener("click",function(e) {
        if (!document.querySelector("#consent-overlay > div").contains(e.target)){
            this.classList.toggle('active');
        }
    });
</script>


    
        <script type="text/javascript" src="/js/ga.js"></script>
    

    

</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
