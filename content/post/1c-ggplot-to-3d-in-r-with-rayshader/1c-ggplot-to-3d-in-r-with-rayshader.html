---
title: "Turn your GGplot to 3D animation. Awesome 2D to 3D plots in R with Rayshader"
author: Carlos Vecina
date: '2019-07-27'
slug: "ggplot-to-3d-in-r-with-rayshader"
categories:
  - R
tags:
  - rayshader
  - ggplot
  - viz
  - vizR
  - visualization
subtitle: ''
summary: ''
authors: [carlos-vecina]
lastmod: '2019-09-24T21:56:15+02:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []


---



<hr />
<p><em>In 3 minutes reading, You will learn how to turn your ggplot visualizations into amazing interactive 3D plots you can export or embed in HTML/Rmarkdown.</em></p>
<p><em>Or even better, you will export as mp4 an animation rotating the figure.</em></p>
<hr />
<p><img src="/post/1c-ggplot-to-3d-in-r-with-rayshader/1c-ggplot-to-3d-in-r-with-rayshader_files/rayshader_header.png" /></p>
<p><br></p>
<div id="introduction" class="section level2">
<h2><strong>1. Introduction</strong></h2>
<p><br></p>
<p>During the last weeks a ‘new’ package has received the R community attention. We say ‘new’ because it joined recently the CRAN, althought the very first commits in github repo date back more than a year. Its name is <strong>rayshader</strong> and in the author’s own words:</p>
<p><br></p>
<blockquote>
<p>“rayshader uses elevation data in a base R matrix and a combination of raytracing, spherical texture mapping, overlays, and ambient occlusion to generate beautiful topographic 2D and 3D maps”</p>
</blockquote>
<p><br></p>
<p>In my view, Tyler Morgan-Wall (package’s author) hit the jackpot with the new addition of two specific functions. These are plot_gg() and render_movie(). The first one converts the ggplot to a 3D figure using one or two lines of code making it deadly-simple. The second one renders an animation in which we can set up several parameters like zoom, fps, angles and inclinations… as user-friendly as possible.</p>
<p><br></p>
<p><img src="/post/1c-ggplot-to-3d-in-r-with-rayshader/1c-ggplot-to-3d-in-r-with-rayshader_files/rayshader_repo.png" /></p>
<p><br></p>
<div id="lets-try-these-new-functionalities" class="section level4">
<h4><strong>Let’s try these new functionalities! </strong></h4>
<p>The only condition you must have a color or fill <em>aesthetic</em>, unless you can also play in the same plot wiht size.
As we discussed in “XXXXXXX” 3D are not the right choice for most of the data visualization cases. Therefore, I tried to bring to this article a non gratuitous example.</p>
<p>As a practical challenge, we will visualize in an interactive 3D map the average age in each city of Spain. Cool? First of all we need the population stats. We get it from the INE webpage. Secondly we have to delimiter Spanish cities with they GIS coordinates. Then we are merging these data to create a ggplot chart. Once we have the ggplot object we are going to use the rayshader package to map color aesthetic to the third spatial dimension. To conclude, we are going to render it as rotating 3D video.</p>
<p>Let´s do it step by step.</p>
<p><br></p>
</div>
</div>
<div id="visualazing-spanish-cities-average-age." class="section level2">
<h2><strong>2. Visualazing Spanish cities average age.</strong></h2>
<p>We usually want to start our pratical work drawing the main steps in our project and our principal goals. So in a general layer, we want to visualiza the average age. Firstly in a ggplot-color way, go one step further and make the plot 3D and end with an animation where the Z axis will be the average age.</p>
<p><br></p>
<div id="downloading-census-data" class="section level3">
<h3>2.1- Downloading census data</h3>
<p>As said, for our purpose, we need to collect data from two sources. We use INE open data portal to download census ages data by city. After a not very user-friendly search, we got it. I provide you the following link, where you can find the continuous register statistics:
<a href="http://www.ine.es/dyngs/INEbase/es/operacion.htm?c=Estadistica_C&amp;cid=1254736177012&amp;menu=resultados&amp;secc=1254736195461&amp;idp=1254734710990">link</a>.</p>
<p>Aiming to keep focused, we don’t get distracted and we are going to download the 2018 file. However, is worth noting the <a href="https://github.com/oddworldng/INEbaseR/"><em>INEbase</em></a> efforts to make easier the INE open data platform.</p>
<p>We start loading (or downloading) the packages we are going to use. In other article or tip we will provide a custom function to Load and Download Rpackages in onle line.
Moreover we define the required functions and download directories.</p>
<pre class="r"><code>if (!require(pxR)) {
  install.packages(&quot;pxR&quot;, repos = &quot;http://cran.us.r-project.org&quot;)
  require(pxR)
}
if (!require(RColorBrewer)) {
  install.packages(&quot;RColorBrewer&quot;, repos = &quot;http://cran.us.r-project.org&quot;)
  require(RColorBrewer)
}

if (!require(rgeos)) {
  install.packages(&quot;rgeos&quot;, repos = &quot;http://cran.us.r-project.org&quot;)
  require(rgeos)
  install.packages(&quot;rgdal&quot;, repos = &quot;http://cran.us.r-project.org&quot;) # reinstall cause gpclib dependencie https://stackoverflow.com/questions/30790036/error-istruegpclibpermitstatus-is-not-true
  require(rgdal)
}
if (!require(rgdal)) {
  install.packages(&quot;rgdal&quot;, repos = &quot;http://cran.us.r-project.org&quot;)
  require(rgdal)
}
if (!require(knitr)) {
  install.packages(&quot;knitr&quot;, repos = &quot;http://cran.us.r-project.org&quot;)
  require(knitr)
}
if (!require(rayshader)) {
  install.packages(&quot;rayshader&quot;, repos = &quot;http://cran.us.r-project.org&quot;)
  require(rayshader)
}
if (!require(magrittr)) {
  install.packages(&quot;magrittr&quot;, repos = &quot;http://cran.us.r-project.org&quot;)
  require(magrittr)
}
if (!require(tidyverse)) {
  install.packages(&quot;tidyverse&quot;, repos = &quot;http://cran.us.r-project.org&quot;)
  require(tidyverse)
}
if (!require(RColorBrewer)) {
  install.packages(&quot;RColorBrewer&quot;, repos = &quot;http://cran.us.r-project.org&quot;)
  require(RColorBrewer)
}
as.numeric.factor &lt;- function(x) {    # Custom function to convert fctr to num factor value
    return(suppressWarnings(as.numeric(levels(x))[x]))
}
 
if(!dir.exists(&quot;data&quot;)) dir.create(&quot;data&quot;)  # Create the download directory</code></pre>
<p><br></p>
<p>Downloading INE 2018 file:</p>
<pre class="r"><code>utils::download.file(url = &quot;http://www.ine.es/pcaxisdl/t20/e245/p05/a2018/l0/00000006.px&quot;,
                     destfile = &quot;data/census_2018.px&quot;)</code></pre>
<p><br></p>
<p>We parse the data to obtain a name,pcode,average age dataframe</p>
<pre class="r"><code>tbl_census_2018 &lt;- read.px(&quot;data/census_2018.px&quot;) %&gt;%              # Load &amp; format
  as.tibble()
tbl_census_2018 %&lt;&gt;% 
  set_names(c(&quot;age&quot;, &quot;city&quot;, &quot;sex&quot;, &quot;population&quot;)) %&gt;%             # Cambiamos los nombre
  na.omit() %&gt;%                                                    # Na rmv
  filter((city!=&quot;Total&quot;)&amp;(age!=&quot;Total&quot;)&amp;(sex==&quot;Ambos sexos&quot;)) %&gt;%  # Duplicate info rmv
  separate(city, c(&#39;postal_code&#39;, &#39;city_name&#39;), sep=&quot;-&quot;) %&gt;%       # Sep City column
  mutate(age = as.numeric.factor(age)) %&gt;%                         # Conv to numeric
  group_by(city_name, postal_code) %&gt;%                             # Group to operate
  summarise(avg_age = sum(population*age,na.rm = T)/sum(population,na.rm=T)) %&gt;%  # Avg age
  select(city_name, postal_code, avg_age)                          # Discard columns
kable(                                                             # Just Rmarkdown format
  tbl_census_2018 %&gt;% head(2)
  )</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">city_name</th>
<th align="left">postal_code</th>
<th align="right">avg_age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Ababuj</td>
<td align="left">44001</td>
<td align="right">52.40789</td>
</tr>
<tr class="even">
<td align="left">Abades</td>
<td align="left">40001</td>
<td align="right">45.40000</td>
</tr>
</tbody>
</table>
<p><br></p>
</div>
<div id="downloading-gis-data" class="section level3">
<h3>2.2- Downloading GIS data</h3>
<p>The second source is the Geo data. We will use cities coordinates and matching it with Spanish register data previously obtained.</p>
<p>Downloading map overlay:</p>
<pre class="r"><code>temp &lt;- tempfile()                              # Create the tempfile
u=&quot;http://www.arcgis.com/sharing/rest/content/items/8e31c4c1a0b348f79058f212d0d807a1/data&quot;
utils::download.file(url = u, destfile = temp,
                     mode=&quot;wb&quot;)                 # Binary mode for correct download

unzip(temp, exdir = &quot;data/cities_gis&quot;)          # Unzip in data/cities_gis
unlink(temp)                                    # Delete temp file</code></pre>
<p>We parse the spatial information to convert it into tabular data. We expect that the Canary Islands coordinates will skew the plot, so it’s our decision to keep focused in our 3D objetive and filter peninsular coordinates. It’s also possible, and a better practice, to move insular coordinates looking for a compact plot, instead of filter them out.</p>
<p>To complete this data processing, we use fortify function that allows us to don’t load more packages. However, this function throws a warning suggesting the broom::tidy() one.</p>
<pre class="r"><code>tlb_cities_gis &lt;- readOGR(dsn = &quot;data/cities_gis/Municipios_ETRS89_30N.shp&quot;,
                              verbose=FALSE)    # Spatial data reading
tlb_cities_gis %&lt;&gt;% 
  fortify(region = &quot;Codigo&quot;) # %&gt;%             # Conv &quot;spatial object&quot; to data.frame
  # broom::tidy()

plot_canarias &lt;- F                              # Control param, initial app config

if(plot_canarias==F){                           # Should be moduled in a funct
  tlb_cities_gis %&lt;&gt;%
  filter((long&gt;0) &amp; (lat&gt;4000000))              # Filter peninsular data
} </code></pre>
<p>Finaly, we join both creating the final dataset, which we are going to use to make the plots. Note that we use left join to keep de geo data.</p>
<pre class="r"><code>tbl_cities_avg_age &lt;- tlb_cities_gis %&gt;% 
  left_join(tbl_census_2018, by = c(&quot;id&quot; = &quot;postal_code&quot;)) </code></pre>
<p>As a good practice, we are going to check the number of NAs generated after the left join. These NAs meaning is that there are cities localized but without average year information</p>
<p>e can see that these missing values represents just 1% of the data, so we are going to impute them with the previous costal pode info. Bet that you can easily improve this procedure but I consider it’s prety good enought seeing the low NA ratio.</p>
<pre class="r"><code>kable(                                                      # RMarkdown output format
  tbl_cities_avg_age %&gt;%
    group_by(id) %&gt;%
    summarise(na = sum(is.na(avg_age))) %&gt;%                 # NAs by city
    summarise(missing_perc = sum(na&gt;0)/length(na)*100) %&gt;%  # Perc cities with at least 1 na 
    select(missing_perc)
  ,
  align = &quot;c&quot;
  )</code></pre>
<table>
<thead>
<tr class="header">
<th align="center">missing_perc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">0.9268413</td>
</tr>
</tbody>
</table>
<pre class="r"><code>tbl_cities_avg_age %&lt;&gt;%       
  arrange(id) %&gt;% 
  fill(avg_age, .direction = &quot;down&quot;)            # Fill with the previous pc data.</code></pre>
<p><br></p>
</div>
<div id="ggplot-visualization" class="section level3">
<h3>2.3- GGplot visualization</h3>
<p>Once we have created the final dataset, we are able to start ploting it. Of course longitude in X-axis and latitude en Y-axis. Firstly average city age is represented using a color palette. Red colours are assigned to older people and blue ones to younger city population. We get it in ggplot with the fill aesthetic.</p>
<pre class="r"><code>myPalette &lt;- colorRampPalette(rev(brewer.pal(11, &quot;Spectral&quot;)))      # Create reverse Spectral palette

plot_cities &lt;- ggplot() +
  geom_polygon(data = tbl_cities_avg_age, aes(fill = avg_age,   
                                         x = long, 
                                         y = lat, 
                                         group = id)) +      # Dummy variable to correct fill by PCode.
  scale_fill_gradientn(colours=myPalette(4)) +                 # Choose palette colours.
  labs(fill=&quot;Avg age&quot;)
plot(plot_cities)</code></pre>
<p><img src="/post/1c-ggplot-to-3d-in-r-with-rayshader/1c-ggplot-to-3d-in-r-with-rayshader_files/figure-html/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
</div>
<div id="d-rayshader-visualization" class="section level3">
<h3>2.4- 3D Rayshader Visualization!</h3>
<p>That was pretty nice. It’s sure that you can reach the general propose to be able to locate inmediately older an younger zones. Although as we discuss in XXX, human eyes aren’t ready to distinguiss almost nothing but big color contrasts. What about complement color with a third dimension through z axis?</p>
<p>Let’s see how it works</p>
<pre class="r"><code>plot_gg(plot_cities,multicore=TRUE,width=5,height=3,scale=310)    # Plot_gg de rayshader
render_snapshot()</code></pre>
<p><img src="/post/1c-ggplot-to-3d-in-r-with-rayshader/1c-ggplot-to-3d-in-r-with-rayshader_files/figure-html/unnamed-chunk-10-1.png" width="200%" height="200%" style="display: block; margin: auto;" /></p>
<p><br></p>
<p>Hmm you told something about render_movie()… What if we anime it?</p>
<p><br></p>
</div>
<div id="d-animation-with-rayshader" class="section level3">
<h3>2.5- 3D animation with rayshader</h3>
<p>In the last plot, it results the correct angle election as a key point. But what if we animate it with a rotating effect?</p>
<p>This is what the following function take cares on:</p>
<pre class="r"><code>render_movie(&quot;img/movie_spain.mp4&quot;,frames = 720, fps=30,zoom=0.6,fov = 30)</code></pre>
<p><img src="/post/1c-ggplot-to-3d-in-r-with-rayshader/1c-ggplot-to-3d-in-r-with-rayshader_files/movie_spain.gif" /></p>
</div>
</div>
